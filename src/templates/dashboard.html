{% extends "layout.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-5 fw-bold" style="color: #f9fafb;">Dashboard</h1>
        <p class="text-muted">Bem-vindo ao seu sistema de gestão financeira</p>
    </div>
</div>

<!-- KPIs Row 1 -->
<div class="row mb-4">
    <div class="col-md-6 col-lg-3 mb-3">
        <div class="ls-card p-4">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <p class="text-muted mb-2">Contas a Pagar Vencidas</p>
                    <h2 class="fw-bold" style="color: #ef4444;">{{ contas_pagar_aberto }}</h2>
                </div>
                <div style="font-size: 28px; color: #ef4444; opacity: 0.6;">
                    <i class="fas fa-arrow-down"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6 col-lg-3 mb-3">
        <div class="ls-card p-4">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <p class="text-muted mb-2">Contas a Receber Vencidas</p>
                    <h2 class="fw-bold" style="color: #22c55e;">{{ contas_receber_aberto }}</h2>
                </div>
                <div style="font-size: 28px; color: #22c55e; opacity: 0.6;">
                    <i class="fas fa-arrow-up"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6 col-lg-3 mb-3">
        <div class="ls-card p-4">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <p class="text-muted mb-2">Total de Entidades</p>
                    <h2 class="fw-bold" style="color: #3b82f6;">{{ total_entidades }}</h2>
                </div>
                <div style="font-size: 28px; color: #3b82f6; opacity: 0.6;">
                    <i class="fas fa-users"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6 col-lg-3 mb-3">
        <div class="ls-card p-4">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <p class="text-muted mb-2">Contas Bancárias</p>
                    <h2 class="fw-bold" style="color: #8b5cf6;">{{ total_contas_banco }}</h2>
                </div>
                <div style="font-size: 28px; color: #8b5cf6; opacity: 0.6;">
                    <i class="fas fa-university"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-lg-3 mb-3">
        <div class="ls-card p-4">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <p class="text-muted mb-2">Valor Previsto a Receber</p>
                    <h2 class="fw-bold" style="color: #22c55e;">R$ {{ previsto_a_receber|brl }}</h2>
                </div>
                <div style="font-size: 28px; color: #22c55e; opacity: 0.6;">
                    <i class="fas fa-calendar-plus"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-lg-3 mb-3">
        <div class="ls-card p-4">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <p class="text-muted mb-2">Valor Previsto a Pagar</p>
                    <h2 class="fw-bold" style="color: #ef4444;">R$ {{ previsto_a_pagar|brl }}</h2>
                </div>
                <div style="font-size: 28px; color: #ef4444; opacity: 0.6;">
                    <i class="fas fa-calendar-minus"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-lg-3 mb-3">
        <div class="ls-card p-4">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <p class="text-muted mb-2">Total Pago no Mês</p>
                    <h2 class="fw-bold" style="color: #ef4444;">R$ {{ total_pago_mes|brl }}</h2>
                </div>
                <div style="font-size: 28px; color: #ef4444; opacity: 0.6;">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-lg-3 mb-3">
        <div class="ls-card p-4">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <p class="text-muted mb-2">Total Recebido no Mês</p>
                    <h2 class="fw-bold" style="color: #22c55e;">R$ {{ total_recebido_mes|brl }}</h2>
                </div>
                <div style="font-size: 28px; color: #22c55e; opacity: 0.6;">
                    <i class="fas fa-hand-holding-usd"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Necessidade/Disponibilidade do Dia -->
<div class="row mb-4">
    <div class="col-md-6 mb-3">
        <div class="ls-card p-4">
            <p class="text-muted mb-2">Necessidade do Dia (Previsto)</p>
            <h3 class="fw-bold" style="color: #ef4444;">R$ {{ necessidade_hoje|brl }}</h3>
            <p class="text-muted mb-0">
                Pagar: R$ {{ pagar_previsto_hoje|brl }} | Receber: R$ {{ receber_previsto_hoje|brl }}
            </p>
        </div>
    </div>
    <div class="col-md-6 mb-3">
        <div class="ls-card p-4">
            <p class="text-muted mb-2">Disponibilidade do Dia (Previsto)</p>
            <h3 class="fw-bold" style="color: #22c55e;">R$ {{ disponibilidade_hoje|brl }}</h3>
            <p class="text-muted mb-0">Saldo atual + receber - pagar</p>
        </div>
    </div>
</div>

<!-- Saldo Total -->
<div class="row mb-4">
    <div class="col-12">
        <div class="ls-card p-4">
            <h4 class="mb-3" style="color: #f9fafb;">Saldo Total</h4>
            <h2 class="fw-bold" style="color: #22c55e; font-size: 36px;">
                R$ {{ saldo_total|brl }}
            </h2>
            <p class="text-muted mt-2">Soma de todas as contas bancárias ativas</p>
        </div>
    </div>
</div>

<!-- Grafico Fluxo de Caixa -->
<div class="row mb-4">
    <div class="col-12">
        <div class="ls-card p-4">
            <h4 class="mb-4" style="color: #f9fafb;">Fluxo de Caixa (Previsto x Realizado)</h4>
            <canvas id="fluxoCaixaChart" height="100"></canvas>
        </div>
    </div>
</div>

<!-- Últimos Lançamentos -->
<div class="row">
    <div class="col-12">
        <div class="ls-card p-4">
            <h4 class="mb-4" style="color: #f9fafb;">Últimos Lançamentos</h4>
            {% if ultimos_lancamentos %}
                <div class="table-responsive">
                    <table class="table table-hover" style="border-color: rgba(148, 163, 184, 0.25); color: #e5e7eb;">
                        <thead style="border-bottom: 1px solid rgba(148, 163, 184, 0.25);">
                            <tr>
                                <th>Data</th>
                                <th>Documento</th>
                                <th>Entidade</th>
                                <th>Conta</th>
                                <th class="text-end">Valor</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for lancamento in ultimos_lancamentos %}
                            <tr>
                                <td>{{ lancamento.data_evento.strftime('%d/%m/%Y') }}</td>
                                <td>{{ lancamento.numero_documento or 'N/A' }}</td>
                                <td>{{ lancamento.entidade.nome }}</td>
                                <td>{{ lancamento.fluxo_conta.codigo }}</td>
                                <td class="text-end">R$ {{ lancamento.valor_real|brl }}</td>
                                <td>
                                    {% if lancamento.status == 'pago' %}
                                        <span class="badge bg-success">Pago</span>
                                    {% elif lancamento.status == 'vencido' %}
                                        <span class="badge bg-danger">Vencido</span>
                                    {% else %}
                                        <span class="badge bg-warning">Aberto</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-muted text-center py-4">
                    <i class="fas fa-inbox fa-2x mb-3 d-block"></i>
                    Nenhum lançamento encontrado
                </p>
            {% endif %}
        </div>
    </div>
</div>

<style>
    table tbody tr:hover {
        background-color: rgba(37, 99, 235, 0.1) !important;
    }

    table tbody td {
        padding: 12px 8px;
        border-color: rgba(148, 163, 184, 0.15) !important;
    }

    .badge {
        padding: 4px 8px;
        font-size: 12px;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
    const fluxoLabels = {{ grafico_labels|tojson }};
    const fluxoPrevisto = {{ grafico_previsto|tojson }};
    const fluxoRealizado = {{ grafico_realizado|tojson }};

    const ctxFluxo = document.getElementById('fluxoCaixaChart');
    if (ctxFluxo) {
        new Chart(ctxFluxo, {
            type: 'line',
            data: {
                labels: fluxoLabels,
                datasets: [
                    {
                        label: 'Previsto',
                        data: fluxoPrevisto,
                        borderColor: '#fbbf24',
                        backgroundColor: 'rgba(251, 191, 36, 0.15)',
                        tension: 0.35,
                        fill: true
                    },
                    {
                        label: 'Realizado',
                        data: fluxoRealizado,
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.15)',
                        tension: 0.35,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        labels: { color: '#e5e7eb' }
                    }
                },
                scales: {
                    x: { ticks: { color: '#cbd5e1' }, grid: { color: 'rgba(148, 163, 184, 0.15)' } },
                    y: { ticks: { color: '#cbd5e1' }, grid: { color: 'rgba(148, 163, 184, 0.15)' } }
                }
            }
        });
    }
</script>
{% endblock %}
